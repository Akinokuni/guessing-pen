name: ç³»ç»Ÿç»´æŠ¤å’Œæ¸…ç†

on:
  # æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œç»´æŠ¤ä»»åŠ¡
  schedule:
    - cron: '0 2 * * *'
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      cleanup_type:
        description: 'æ¸…ç†ç±»å‹'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - images
          - logs
          - backups
          - cache
      force_cleanup:
        description: 'å¼ºåˆ¶æ¸…ç† (åˆ é™¤æ‰€æœ‰æ—§æ•°æ®)'
        required: false
        default: false
        type: boolean

env:
  ACR_REGISTRY: registry.cn-hangzhou.aliyuncs.com
  ACR_NAMESPACE: guessing-pen

jobs:
  # æ¸…ç†Dockeré•œåƒ
  cleanup-images:
    name: æ¸…ç†Dockeré•œåƒ
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || inputs.cleanup_type == 'all' || inputs.cleanup_type == 'images'
    
    steps:
      - name: æ¸…ç†GitHub Actionsç¼“å­˜
        uses: actions/github-script@v7
        with:
          script: |
            const caches = await github.rest.actions.getActionsCaches({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            
            // ä¿ç•™æœ€è¿‘10ä¸ªç¼“å­˜ï¼Œåˆ é™¤å…¶ä»–çš„
            const cachesToDelete = caches.data.actions_caches
              .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
              .slice(10);
            
            for (const cache of cachesToDelete) {
              try {
                await github.rest.actions.deleteActionsCacheById({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  cache_id: cache.id,
                });
                console.log(`å·²åˆ é™¤ç¼“å­˜: ${cache.key}`);
              } catch (error) {
                console.log(`åˆ é™¤ç¼“å­˜å¤±è´¥: ${cache.key} - ${error.message}`);
              }
            }
            
            console.log(`æ¸…ç†å®Œæˆï¼Œåˆ é™¤äº† ${cachesToDelete.length} ä¸ªæ—§ç¼“å­˜`);

  # æœåŠ¡å™¨ç»´æŠ¤
  server-maintenance:
    name: æœåŠ¡å™¨ç»´æŠ¤
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || inputs.cleanup_type == 'all' || inputs.cleanup_type != 'cache'
    
    strategy:
      matrix:
        environment: [production]
        # å¦‚æœæœ‰stagingç¯å¢ƒï¼Œå¯ä»¥æ·»åŠ : [production, staging]
    
    steps:
      - name: æœåŠ¡å™¨æ¸…ç†å’Œç»´æŠ¤
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ matrix.environment == 'production' && secrets.PROD_SERVER_HOST || secrets.STAGING_SERVER_HOST }}
          username: ${{ matrix.environment == 'production' && secrets.PROD_SERVER_USER || secrets.STAGING_SERVER_USER }}
          key: ${{ matrix.environment == 'production' && secrets.PROD_SERVER_SSH_KEY || secrets.STAGING_SERVER_SSH_KEY }}
          port: ${{ matrix.environment == 'production' && secrets.PROD_SERVER_PORT || secrets.STAGING_SERVER_PORT || 22 }}
          script: |
            set -e
            
            # è®¾ç½®å˜é‡
            CLEANUP_TYPE="${{ inputs.cleanup_type || 'all' }}"
            FORCE_CLEANUP="${{ inputs.force_cleanup || 'false' }}"
            ENVIRONMENT="${{ matrix.environment }}"
            
            if [[ "$ENVIRONMENT" == "production" ]]; then
              DEPLOY_PATH="/opt/guessing-pen"
            else
              DEPLOY_PATH="/opt/guessing-pen-staging"
            fi
            
            # åˆ›å»ºç»´æŠ¤æ—¥å¿—
            MAINTENANCE_LOG="${DEPLOY_PATH}/logs/maintenance-$(date +%Y%m%d-%H%M%S).log"
            mkdir -p "${DEPLOY_PATH}/logs"
            
            # æ—¥å¿—å‡½æ•°
            log_info() {
              echo "[INFO] $(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$MAINTENANCE_LOG"
            }
            
            log_success() {
              echo "[SUCCESS] $(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$MAINTENANCE_LOG"
            }
            
            log_warning() {
              echo "[WARNING] $(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$MAINTENANCE_LOG"
            }
            
            # æ¸…ç†Dockeré•œåƒ
            cleanup_docker_images() {
              log_info "ğŸ§¹ æ¸…ç†Dockeré•œåƒ..."
              
              # æ¸…ç†æœªä½¿ç”¨çš„é•œåƒ
              docker image prune -f
              
              # æ¸…ç†æ—§ç‰ˆæœ¬é•œåƒï¼ˆä¿ç•™æœ€è¿‘5ä¸ªç‰ˆæœ¬ï¼‰
              local frontend_images=$(docker images "${{ env.ACR_REGISTRY }}/${{ env.ACR_NAMESPACE }}/guessing-pen-frontend" --format "{{.Tag}}" | grep -v latest | sort -V)
              local api_images=$(docker images "${{ env.ACR_REGISTRY }}/${{ env.ACR_NAMESPACE }}/guessing-pen-api" --format "{{.Tag}}" | grep -v latest | sort -V)
              
              # åˆ é™¤æ—§çš„å‰ç«¯é•œåƒ
              if [[ "$FORCE_CLEANUP" == "true" ]]; then
                local keep_count=3
              else
                local keep_count=5
              fi
              
              echo "$frontend_images" | head -n -$keep_count | while read tag; do
                if [[ -n "$tag" && "$tag" != "latest" ]]; then
                  log_info "åˆ é™¤æ—§å‰ç«¯é•œåƒ: $tag"
                  docker rmi "${{ env.ACR_REGISTRY }}/${{ env.ACR_NAMESPACE }}/guessing-pen-frontend:$tag" || true
                fi
              done
              
              echo "$api_images" | head -n -$keep_count | while read tag; do
                if [[ -n "$tag" && "$tag" != "latest" ]]; then
                  log_info "åˆ é™¤æ—§APIé•œåƒ: $tag"
                  docker rmi "${{ env.ACR_REGISTRY }}/${{ env.ACR_NAMESPACE }}/guessing-pen-api:$tag" || true
                fi
              done
              
              # æ¸…ç†æ‚¬ç©ºé•œåƒ
              docker image prune -f
              
              log_success "Dockeré•œåƒæ¸…ç†å®Œæˆ"
            }
            
            # æ¸…ç†æ—¥å¿—æ–‡ä»¶
            cleanup_logs() {
              log_info "ğŸ§¹ æ¸…ç†æ—¥å¿—æ–‡ä»¶..."
              
              cd "$DEPLOY_PATH"
              
              # æ¸…ç†åº”ç”¨æ—¥å¿—ï¼ˆä¿ç•™æœ€è¿‘30å¤©ï¼‰
              if [[ "$FORCE_CLEANUP" == "true" ]]; then
                local keep_days=7
              else
                local keep_days=30
              fi
              
              find logs/ -name "*.log" -type f -mtime +$keep_days -delete 2>/dev/null || true
              
              # æ¸…ç†Dockerå®¹å™¨æ—¥å¿—
              docker system prune -f --volumes
              
              # æ¸…ç†ç³»ç»Ÿæ—¥å¿—ï¼ˆå¦‚æœæƒé™å…è®¸ï¼‰
              if command -v journalctl &> /dev/null; then
                sudo journalctl --vacuum-time=30d 2>/dev/null || log_warning "æ— æ³•æ¸…ç†ç³»ç»Ÿæ—¥å¿—ï¼Œæƒé™ä¸è¶³"
              fi
              
              log_success "æ—¥å¿—æ–‡ä»¶æ¸…ç†å®Œæˆ"
            }
            
            # æ¸…ç†å¤‡ä»½æ–‡ä»¶
            cleanup_backups() {
              log_info "ğŸ§¹ æ¸…ç†å¤‡ä»½æ–‡ä»¶..."
              
              cd "$DEPLOY_PATH"
              
              # æ¸…ç†æ—§å¤‡ä»½ï¼ˆä¿ç•™æœ€è¿‘20ä¸ªï¼‰
              if [[ "$FORCE_CLEANUP" == "true" ]]; then
                local keep_count=10
              else
                local keep_count=20
              fi
              
              # æŒ‰æ—¶é—´æ’åºï¼Œåˆ é™¤æ—§å¤‡ä»½
              ls -t backups/backup-*.json 2>/dev/null | tail -n +$((keep_count + 1)) | xargs -r rm -f
              
              # æ¸…ç†è¶…è¿‡90å¤©çš„å¤‡ä»½
              find backups/ -name "backup-*.json" -type f -mtime +90 -delete 2>/dev/null || true
              
              log_success "å¤‡ä»½æ–‡ä»¶æ¸…ç†å®Œæˆ"
            }
            
            # ç³»ç»Ÿèµ„æºæ£€æŸ¥
            system_health_check() {
              log_info "ğŸ¥ ç³»ç»Ÿå¥åº·æ£€æŸ¥..."
              
              # æ£€æŸ¥ç£ç›˜ç©ºé—´
              local disk_usage=$(df -h / | awk 'NR==2 {print $5}' | sed 's/%//')
              log_info "ç£ç›˜ä½¿ç”¨ç‡: ${disk_usage}%"
              
              if [[ $disk_usage -gt 80 ]]; then
                log_warning "âš ï¸ ç£ç›˜ä½¿ç”¨ç‡è¿‡é«˜: ${disk_usage}%"
              fi
              
              # æ£€æŸ¥å†…å­˜ä½¿ç”¨
              local memory_usage=$(free | awk 'NR==2{printf "%.2f", $3*100/$2}')
              log_info "å†…å­˜ä½¿ç”¨ç‡: ${memory_usage}%"
              
              # æ£€æŸ¥DockeræœåŠ¡çŠ¶æ€
              if systemctl is-active --quiet docker; then
                log_info "âœ… DockeræœåŠ¡æ­£å¸¸è¿è¡Œ"
              else
                log_warning "âŒ DockeræœåŠ¡å¼‚å¸¸"
              fi
              
              # æ£€æŸ¥åº”ç”¨å®¹å™¨çŠ¶æ€
              cd "$DEPLOY_PATH"
              local container_status=$(docker-compose -f docker-compose.prod.yml ps --format json 2>/dev/null || echo "[]")
              log_info "å®¹å™¨çŠ¶æ€: $container_status"
              
              # æ£€æŸ¥æœåŠ¡å¯ç”¨æ€§
              if curl -f -s http://localhost:80/health > /dev/null 2>&1; then
                log_info "âœ… å‰ç«¯æœåŠ¡æ­£å¸¸"
              else
                log_warning "âŒ å‰ç«¯æœåŠ¡å¼‚å¸¸"
              fi
              
              if curl -f -s http://localhost:3005/health > /dev/null 2>&1; then
                log_info "âœ… APIæœåŠ¡æ­£å¸¸"
              else
                log_warning "âŒ APIæœåŠ¡å¼‚å¸¸"
              fi
              
              log_success "ç³»ç»Ÿå¥åº·æ£€æŸ¥å®Œæˆ"
            }
            
            # ç”Ÿæˆç»´æŠ¤æŠ¥å‘Š
            generate_maintenance_report() {
              log_info "ğŸ“Š ç”Ÿæˆç»´æŠ¤æŠ¥å‘Š..."
              
              local report_file="${DEPLOY_PATH}/maintenance-report-$(date +%Y%m%d).json"
              
              # æ”¶é›†ç³»ç»Ÿä¿¡æ¯
              local disk_usage=$(df -h / | awk 'NR==2 {print $5}')
              local memory_usage=$(free | awk 'NR==2{printf "%.2f%%", $3*100/$2}')
              local docker_images_count=$(docker images | wc -l)
              local containers_count=$(docker ps -a | wc -l)
              
              # ç”ŸæˆæŠ¥å‘Š
              cat > "$report_file" << EOF
            {
              "timestamp": "$(date -u +'%Y-%m-%dT%H:%M:%SZ')",
              "environment": "$ENVIRONMENT",
              "cleanup_type": "$CLEANUP_TYPE",
              "force_cleanup": "$FORCE_CLEANUP",
              "system_info": {
                "disk_usage": "$disk_usage",
                "memory_usage": "$memory_usage",
                "docker_images_count": $docker_images_count,
                "containers_count": $containers_count
              },
              "maintenance_log": "$MAINTENANCE_LOG"
            }
            EOF
              
              log_success "ç»´æŠ¤æŠ¥å‘Šç”Ÿæˆå®Œæˆ: $report_file"
            }
            
            # ä¸»æ‰§è¡Œé€»è¾‘
            log_info "ğŸ”§ å¼€å§‹ç³»ç»Ÿç»´æŠ¤ - ç¯å¢ƒ: $ENVIRONMENT"
            log_info "æ¸…ç†ç±»å‹: $CLEANUP_TYPE"
            log_info "å¼ºåˆ¶æ¸…ç†: $FORCE_CLEANUP"
            
            # æ‰§è¡Œç³»ç»Ÿå¥åº·æ£€æŸ¥
            system_health_check
            
            # æ ¹æ®æ¸…ç†ç±»å‹æ‰§è¡Œç›¸åº”æ“ä½œ
            case "$CLEANUP_TYPE" in
              "all")
                cleanup_docker_images
                cleanup_logs
                cleanup_backups
                ;;
              "images")
                cleanup_docker_images
                ;;
              "logs")
                cleanup_logs
                ;;
              "backups")
                cleanup_backups
                ;;
            esac
            
            # å†æ¬¡æ‰§è¡Œå¥åº·æ£€æŸ¥
            system_health_check
            
            # ç”Ÿæˆç»´æŠ¤æŠ¥å‘Š
            generate_maintenance_report
            
            log_success "ğŸ‰ ç³»ç»Ÿç»´æŠ¤å®Œæˆï¼"

  # å‘é€ç»´æŠ¤æŠ¥å‘Š
  maintenance-report:
    name: ç»´æŠ¤æŠ¥å‘Š
    runs-on: ubuntu-latest
    needs: [cleanup-images, server-maintenance]
    if: always()
    
    steps:
      - name: ç”Ÿæˆç»´æŠ¤æ‘˜è¦
        run: |
          echo "ğŸ“Š **ç³»ç»Ÿç»´æŠ¤æŠ¥å‘Š**" > maintenance_summary.md
          echo "" >> maintenance_summary.md
          echo "**æ—¶é—´**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> maintenance_summary.md
          echo "**è§¦å‘æ–¹å¼**: ${{ github.event_name }}" >> maintenance_summary.md
          
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "**æ¸…ç†ç±»å‹**: ${{ inputs.cleanup_type }}" >> maintenance_summary.md
            echo "**å¼ºåˆ¶æ¸…ç†**: ${{ inputs.force_cleanup }}" >> maintenance_summary.md
          fi
          
          echo "" >> maintenance_summary.md
          echo "**æ‰§è¡Œç»“æœ**:" >> maintenance_summary.md
          
          # æ£€æŸ¥å„ä¸ªjobçš„çŠ¶æ€
          if [[ "${{ needs.cleanup-images.result }}" == "success" ]]; then
            echo "- âœ… GitHubç¼“å­˜æ¸…ç†: æˆåŠŸ" >> maintenance_summary.md
          elif [[ "${{ needs.cleanup-images.result }}" == "failure" ]]; then
            echo "- âŒ GitHubç¼“å­˜æ¸…ç†: å¤±è´¥" >> maintenance_summary.md
          elif [[ "${{ needs.cleanup-images.result }}" == "skipped" ]]; then
            echo "- â­ï¸ GitHubç¼“å­˜æ¸…ç†: è·³è¿‡" >> maintenance_summary.md
          fi
          
          if [[ "${{ needs.server-maintenance.result }}" == "success" ]]; then
            echo "- âœ… æœåŠ¡å™¨ç»´æŠ¤: æˆåŠŸ" >> maintenance_summary.md
          elif [[ "${{ needs.server-maintenance.result }}" == "failure" ]]; then
            echo "- âŒ æœåŠ¡å™¨ç»´æŠ¤: å¤±è´¥" >> maintenance_summary.md
          elif [[ "${{ needs.server-maintenance.result }}" == "skipped" ]]; then
            echo "- â­ï¸ æœåŠ¡å™¨ç»´æŠ¤: è·³è¿‡" >> maintenance_summary.md
          fi
          
          echo "" >> maintenance_summary.md
          echo "**æŸ¥çœ‹è¯¦æƒ…**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> maintenance_summary.md
          
          # è¾“å‡ºæ‘˜è¦
          cat maintenance_summary.md
      
      - name: å‘é€ç»´æŠ¤é€šçŸ¥
        if: github.event_name == 'schedule' || inputs.cleanup_type == 'all'
        run: |
          # è¯»å–ç»´æŠ¤æ‘˜è¦
          SUMMARY=$(cat maintenance_summary.md)
          
          echo "ç»´æŠ¤é€šçŸ¥: $SUMMARY"
          
          # è¿™é‡Œå¯ä»¥é›†æˆå®é™…çš„é€šçŸ¥æœåŠ¡
          # curl -X POST -H 'Content-Type: application/json' \
          #   -d "{\"text\": \"$SUMMARY\"}" \
          #   "${{ secrets.WEBHOOK_URL }}"