name: å¥åº·æ£€æŸ¥å’Œç›‘æ§

on:
  # æ¯15åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡å¥åº·æ£€æŸ¥
  schedule:
    - cron: '*/150 * * * *'
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      environment:
        description: 'æ£€æŸ¥ç¯å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
          - all
      check_type:
        description: 'æ£€æŸ¥ç±»å‹'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - basic
          - performance
          - security

env:
  # å¥åº·æ£€æŸ¥è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
  HEALTH_CHECK_TIMEOUT: 30
  # æ€§èƒ½æ£€æŸ¥é˜ˆå€¼
  RESPONSE_TIME_THRESHOLD: 2000  # 2ç§’
  ERROR_RATE_THRESHOLD: 5        # 5%

jobs:
  # åŸºç¡€å¥åº·æ£€æŸ¥
  basic-health-check:
    name: åŸºç¡€å¥åº·æ£€æŸ¥
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || inputs.check_type == 'full' || inputs.check_type == 'basic'
    
    strategy:
      matrix:
        environment: 
          - ${{ (inputs.environment == 'all' && 'production') || (inputs.environment == 'all' && 'staging') || inputs.environment || 'production' }}
    
    outputs:
      health-status: ${{ steps.health-check.outputs.status }}
      response-time: ${{ steps.health-check.outputs.response-time }}
      
    steps:
      - name: è®¾ç½®ç¯å¢ƒå˜é‡
        run: |
          if [[ "${{ matrix.environment }}" == "production" ]]; then
            echo "BASE_URL=${{ vars.PRODUCTION_URL }}" >> $GITHUB_ENV
            echo "API_URL=${{ vars.PRODUCTION_URL }}/api" >> $GITHUB_ENV
          elif [[ "${{ matrix.environment }}" == "staging" ]]; then
            echo "BASE_URL=${{ vars.STAGING_URL }}" >> $GITHUB_ENV
            echo "API_URL=${{ vars.STAGING_URL }}/api" >> $GITHUB_ENV
          fi
      
      - name: å‰ç«¯æœåŠ¡å¥åº·æ£€æŸ¥
        id: frontend-check
        run: |
          echo "ğŸŒ æ£€æŸ¥å‰ç«¯æœåŠ¡: ${{ env.BASE_URL }}"
          
          # æ£€æŸ¥ä¸»é¡µ
          start_time=$(date +%s%3N)
          if curl -f -s -m ${{ env.HEALTH_CHECK_TIMEOUT }} "${{ env.BASE_URL }}" > /dev/null; then
            end_time=$(date +%s%3N)
            response_time=$((end_time - start_time))
            echo "âœ… å‰ç«¯æœåŠ¡æ­£å¸¸ (å“åº”æ—¶é—´: ${response_time}ms)"
            echo "status=healthy" >> $GITHUB_OUTPUT
            echo "response-time=$response_time" >> $GITHUB_OUTPUT
          else
            echo "âŒ å‰ç«¯æœåŠ¡å¼‚å¸¸"
            echo "status=unhealthy" >> $GITHUB_OUTPUT
            echo "response-time=0" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # æ£€æŸ¥å¥åº·æ£€æŸ¥ç«¯ç‚¹
          if curl -f -s -m ${{ env.HEALTH_CHECK_TIMEOUT }} "${{ env.BASE_URL }}/health" > /dev/null; then
            echo "âœ… å‰ç«¯å¥åº·æ£€æŸ¥ç«¯ç‚¹æ­£å¸¸"
          else
            echo "âš ï¸ å‰ç«¯å¥åº·æ£€æŸ¥ç«¯ç‚¹å¼‚å¸¸"
          fi
      
      - name: APIæœåŠ¡å¥åº·æ£€æŸ¥
        id: api-check
        run: |
          echo "ğŸ”§ æ£€æŸ¥APIæœåŠ¡: ${{ env.API_URL }}"
          
          # æ£€æŸ¥APIå¥åº·ç«¯ç‚¹
          start_time=$(date +%s%3N)
          if response=$(curl -f -s -m ${{ env.HEALTH_CHECK_TIMEOUT }} "${{ env.API_URL }}/health"); then
            end_time=$(date +%s%3N)
            response_time=$((end_time - start_time))
            echo "âœ… APIæœåŠ¡æ­£å¸¸ (å“åº”æ—¶é—´: ${response_time}ms)"
            echo "å“åº”å†…å®¹: $response"
            echo "status=healthy" >> $GITHUB_OUTPUT
            echo "response-time=$response_time" >> $GITHUB_OUTPUT
          else
            echo "âŒ APIæœåŠ¡å¼‚å¸¸"
            echo "status=unhealthy" >> $GITHUB_OUTPUT
            echo "response-time=0" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # æ£€æŸ¥æ•°æ®åº“è¿æ¥
          if curl -f -s -m ${{ env.HEALTH_CHECK_TIMEOUT }} "${{ env.API_URL }}/health/db" > /dev/null; then
            echo "âœ… æ•°æ®åº“è¿æ¥æ­£å¸¸"
          else
            echo "âš ï¸ æ•°æ®åº“è¿æ¥å¼‚å¸¸"
          fi
      
      - name: ç»¼åˆå¥åº·çŠ¶æ€
        id: health-check
        run: |
          frontend_status="${{ steps.frontend-check.outputs.status }}"
          api_status="${{ steps.api-check.outputs.status }}"
          
          frontend_time="${{ steps.frontend-check.outputs.response-time }}"
          api_time="${{ steps.api-check.outputs.response-time }}"
          
          if [[ "$frontend_status" == "healthy" && "$api_status" == "healthy" ]]; then
            echo "status=healthy" >> $GITHUB_OUTPUT
            echo "âœ… ${{ matrix.environment }} ç¯å¢ƒæ•´ä½“å¥åº·"
          else
            echo "status=unhealthy" >> $GITHUB_OUTPUT
            echo "âŒ ${{ matrix.environment }} ç¯å¢ƒå­˜åœ¨é—®é¢˜"
            exit 1
          fi
          
          # è®¡ç®—å¹³å‡å“åº”æ—¶é—´
          avg_response_time=$(( (frontend_time + api_time) / 2 ))
          echo "response-time=$avg_response_time" >> $GITHUB_OUTPUT
          echo "å¹³å‡å“åº”æ—¶é—´: ${avg_response_time}ms"

  # æ€§èƒ½æ£€æŸ¥
  performance-check:
    name: æ€§èƒ½æ£€æŸ¥
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && (inputs.check_type == 'full' || inputs.check_type == 'performance')
    needs: basic-health-check
    
    strategy:
      matrix:
        environment: 
          - ${{ (inputs.environment == 'all' && 'production') || (inputs.environment == 'all' && 'staging') || inputs.environment || 'production' }}
    
    steps:
      - name: è®¾ç½®ç¯å¢ƒå˜é‡
        run: |
          if [[ "${{ matrix.environment }}" == "production" ]]; then
            echo "BASE_URL=${{ vars.PRODUCTION_URL }}" >> $GITHUB_ENV
            echo "API_URL=${{ vars.PRODUCTION_URL }}/api" >> $GITHUB_ENV
          elif [[ "${{ matrix.environment }}" == "staging" ]]; then
            echo "BASE_URL=${{ vars.STAGING_URL }}" >> $GITHUB_ENV
            echo "API_URL=${{ vars.STAGING_URL }}/api" >> $GITHUB_ENV
          fi
      
      - name: é¡µé¢åŠ è½½æ€§èƒ½æµ‹è¯•
        run: |
          echo "ğŸš€ æ‰§è¡Œé¡µé¢åŠ è½½æ€§èƒ½æµ‹è¯•..."
          
          # æµ‹è¯•ä¸»é¡µåŠ è½½æ—¶é—´
          for i in {1..5}; do
            start_time=$(date +%s%3N)
            curl -f -s -m 10 "${{ env.BASE_URL }}" > /dev/null
            end_time=$(date +%s%3N)
            response_time=$((end_time - start_time))
            echo "ç¬¬${i}æ¬¡æµ‹è¯•: ${response_time}ms"
            
            if [[ $response_time -gt ${{ env.RESPONSE_TIME_THRESHOLD }} ]]; then
              echo "âš ï¸ å“åº”æ—¶é—´è¶…è¿‡é˜ˆå€¼: ${response_time}ms > ${{ env.RESPONSE_TIME_THRESHOLD }}ms"
            fi
          done
      
      - name: APIæ€§èƒ½æµ‹è¯•
        run: |
          echo "ğŸ”§ æ‰§è¡ŒAPIæ€§èƒ½æµ‹è¯•..."
          
          # æµ‹è¯•APIç«¯ç‚¹æ€§èƒ½
          endpoints=(
            "/health"
            "/api/stats"
            "/api/leaderboard"
          )
          
          for endpoint in "${endpoints[@]}"; do
            echo "æµ‹è¯•ç«¯ç‚¹: $endpoint"
            
            total_time=0
            success_count=0
            
            for i in {1..10}; do
              start_time=$(date +%s%3N)
              if curl -f -s -m 5 "${{ env.BASE_URL }}$endpoint" > /dev/null; then
                end_time=$(date +%s%3N)
                response_time=$((end_time - start_time))
                total_time=$((total_time + response_time))
                success_count=$((success_count + 1))
              fi
            done
            
            if [[ $success_count -gt 0 ]]; then
              avg_time=$((total_time / success_count))
              success_rate=$((success_count * 100 / 10))
              echo "  å¹³å‡å“åº”æ—¶é—´: ${avg_time}ms"
              echo "  æˆåŠŸç‡: ${success_rate}%"
              
              if [[ $success_rate -lt $((100 - ${{ env.ERROR_RATE_THRESHOLD }})) ]]; then
                echo "  âš ï¸ æˆåŠŸç‡ä½äºé˜ˆå€¼: ${success_rate}% < $((100 - ${{ env.ERROR_RATE_THRESHOLD }}))%"
              fi
            else
              echo "  âŒ æ‰€æœ‰è¯·æ±‚éƒ½å¤±è´¥äº†"
            fi
          done

  # å®‰å…¨æ£€æŸ¥
  security-check:
    name: å®‰å…¨æ£€æŸ¥
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && (inputs.check_type == 'full' || inputs.check_type == 'security')
    needs: basic-health-check
    
    strategy:
      matrix:
        environment: 
          - ${{ (inputs.environment == 'all' && 'production') || (inputs.environment == 'all' && 'staging') || inputs.environment || 'production' }}
    
    steps:
      - name: è®¾ç½®ç¯å¢ƒå˜é‡
        run: |
          if [[ "${{ matrix.environment }}" == "production" ]]; then
            echo "BASE_URL=${{ vars.PRODUCTION_URL }}" >> $GITHUB_ENV
          elif [[ "${{ matrix.environment }}" == "staging" ]]; then
            echo "BASE_URL=${{ vars.STAGING_URL }}" >> $GITHUB_ENV
          fi
      
      - name: HTTPå®‰å…¨å¤´æ£€æŸ¥
        run: |
          echo "ğŸ”’ æ£€æŸ¥HTTPå®‰å…¨å¤´..."
          
          # è·å–å“åº”å¤´
          headers=$(curl -I -s "${{ env.BASE_URL }}")
          
          # æ£€æŸ¥å®‰å…¨å¤´
          security_headers=(
            "X-Content-Type-Options"
            "X-Frame-Options"
            "X-XSS-Protection"
            "Strict-Transport-Security"
            "Content-Security-Policy"
          )
          
          for header in "${security_headers[@]}"; do
            if echo "$headers" | grep -i "$header" > /dev/null; then
              echo "âœ… $header: å·²è®¾ç½®"
            else
              echo "âš ï¸ $header: æœªè®¾ç½®"
            fi
          done
      
      - name: SSLè¯ä¹¦æ£€æŸ¥
        run: |
          echo "ğŸ” æ£€æŸ¥SSLè¯ä¹¦..."
          
          # æå–åŸŸå
          domain=$(echo "${{ env.BASE_URL }}" | sed 's|https\?://||' | sed 's|/.*||')
          
          if [[ "${{ env.BASE_URL }}" == https* ]]; then
            # æ£€æŸ¥SSLè¯ä¹¦æœ‰æ•ˆæœŸ
            cert_info=$(echo | openssl s_client -servername "$domain" -connect "$domain:443" 2>/dev/null | openssl x509 -noout -dates 2>/dev/null)
            
            if [[ -n "$cert_info" ]]; then
              echo "âœ… SSLè¯ä¹¦ä¿¡æ¯:"
              echo "$cert_info"
              
              # æ£€æŸ¥è¯ä¹¦æ˜¯å¦å³å°†è¿‡æœŸï¼ˆ30å¤©å†…ï¼‰
              expiry_date=$(echo "$cert_info" | grep "notAfter" | cut -d= -f2)
              expiry_timestamp=$(date -d "$expiry_date" +%s 2>/dev/null || echo "0")
              current_timestamp=$(date +%s)
              days_until_expiry=$(( (expiry_timestamp - current_timestamp) / 86400 ))
              
              if [[ $days_until_expiry -lt 30 ]]; then
                echo "âš ï¸ SSLè¯ä¹¦å°†åœ¨ $days_until_expiry å¤©åè¿‡æœŸ"
              else
                echo "âœ… SSLè¯ä¹¦æœ‰æ•ˆæœŸå……è¶³ ($days_until_expiry å¤©)"
              fi
            else
              echo "âŒ æ— æ³•è·å–SSLè¯ä¹¦ä¿¡æ¯"
            fi
          else
            echo "âš ï¸ ç½‘ç«™æœªä½¿ç”¨HTTPS"
          fi

  # æœåŠ¡å™¨èµ„æºæ£€æŸ¥
  server-resource-check:
    name: æœåŠ¡å™¨èµ„æºæ£€æŸ¥
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && inputs.check_type == 'full'
    
    strategy:
      matrix:
        environment: [production]
        # å¦‚æœæœ‰stagingç¯å¢ƒï¼Œå¯ä»¥æ·»åŠ : [production, staging]
    
    steps:
      - name: æœåŠ¡å™¨èµ„æºç›‘æ§
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ matrix.environment == 'production' && secrets.PROD_SERVER_HOST || secrets.STAGING_SERVER_HOST }}
          username: ${{ matrix.environment == 'production' && secrets.PROD_SERVER_USER || secrets.STAGING_SERVER_USER }}
          key: ${{ matrix.environment == 'production' && secrets.PROD_SERVER_SSH_KEY || secrets.STAGING_SERVER_SSH_KEY }}
          port: ${{ matrix.environment == 'production' && secrets.PROD_SERVER_PORT || secrets.STAGING_SERVER_PORT || 22 }}
          script: |
            echo "ğŸ“Š æœåŠ¡å™¨èµ„æºæ£€æŸ¥ - ${{ matrix.environment }}"
            
            # æ£€æŸ¥CPUä½¿ç”¨ç‡
            cpu_usage=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | sed 's/%us,//')
            echo "CPUä½¿ç”¨ç‡: ${cpu_usage}%"
            
            # æ£€æŸ¥å†…å­˜ä½¿ç”¨ç‡
            memory_info=$(free -m)
            memory_usage=$(echo "$memory_info" | awk 'NR==2{printf "%.2f", $3*100/$2}')
            echo "å†…å­˜ä½¿ç”¨ç‡: ${memory_usage}%"
            echo "å†…å­˜è¯¦æƒ…:"
            echo "$memory_info"
            
            # æ£€æŸ¥ç£ç›˜ä½¿ç”¨ç‡
            echo "ç£ç›˜ä½¿ç”¨æƒ…å†µ:"
            df -h
            
            # æ£€æŸ¥ç³»ç»Ÿè´Ÿè½½
            echo "ç³»ç»Ÿè´Ÿè½½:"
            uptime
            
            # æ£€æŸ¥Dockerå®¹å™¨çŠ¶æ€
            echo "Dockerå®¹å™¨çŠ¶æ€:"
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
            
            # æ£€æŸ¥Dockerèµ„æºä½¿ç”¨
            echo "Dockerèµ„æºä½¿ç”¨:"
            docker stats --no-stream --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.MemPerc}}"
            
            # æ£€æŸ¥ç½‘ç»œè¿æ¥
            echo "ç½‘ç»œè¿æ¥ç»Ÿè®¡:"
            netstat -tuln | grep -E ":80|:443|:3005" || echo "æœªæ‰¾åˆ°ç›¸å…³ç«¯å£ç›‘å¬"

  # ç”Ÿæˆç›‘æ§æŠ¥å‘Š
  monitoring-report:
    name: ç”Ÿæˆç›‘æ§æŠ¥å‘Š
    runs-on: ubuntu-latest
    needs: [basic-health-check, performance-check, security-check, server-resource-check]
    if: always()
    
    steps:
      - name: æ”¶é›†æ£€æŸ¥ç»“æœ
        run: |
          echo "ğŸ“Š **å¥åº·æ£€æŸ¥å’Œç›‘æ§æŠ¥å‘Š**" > monitoring_report.md
          echo "" >> monitoring_report.md
          echo "**æ£€æŸ¥æ—¶é—´**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> monitoring_report.md
          echo "**è§¦å‘æ–¹å¼**: ${{ github.event_name }}" >> monitoring_report.md
          
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "**æ£€æŸ¥ç¯å¢ƒ**: ${{ inputs.environment }}" >> monitoring_report.md
            echo "**æ£€æŸ¥ç±»å‹**: ${{ inputs.check_type }}" >> monitoring_report.md
          fi
          
          echo "" >> monitoring_report.md
          echo "**æ£€æŸ¥ç»“æœ**:" >> monitoring_report.md
          
          # åŸºç¡€å¥åº·æ£€æŸ¥ç»“æœ
          if [[ "${{ needs.basic-health-check.result }}" == "success" ]]; then
            echo "- âœ… åŸºç¡€å¥åº·æ£€æŸ¥: é€šè¿‡" >> monitoring_report.md
            if [[ -n "${{ needs.basic-health-check.outputs.response-time }}" ]]; then
              echo "  - å¹³å‡å“åº”æ—¶é—´: ${{ needs.basic-health-check.outputs.response-time }}ms" >> monitoring_report.md
            fi
          elif [[ "${{ needs.basic-health-check.result }}" == "failure" ]]; then
            echo "- âŒ åŸºç¡€å¥åº·æ£€æŸ¥: å¤±è´¥" >> monitoring_report.md
          elif [[ "${{ needs.basic-health-check.result }}" == "skipped" ]]; then
            echo "- â­ï¸ åŸºç¡€å¥åº·æ£€æŸ¥: è·³è¿‡" >> monitoring_report.md
          fi
          
          # æ€§èƒ½æ£€æŸ¥ç»“æœ
          if [[ "${{ needs.performance-check.result }}" == "success" ]]; then
            echo "- âœ… æ€§èƒ½æ£€æŸ¥: é€šè¿‡" >> monitoring_report.md
          elif [[ "${{ needs.performance-check.result }}" == "failure" ]]; then
            echo "- âŒ æ€§èƒ½æ£€æŸ¥: å¤±è´¥" >> monitoring_report.md
          elif [[ "${{ needs.performance-check.result }}" == "skipped" ]]; then
            echo "- â­ï¸ æ€§èƒ½æ£€æŸ¥: è·³è¿‡" >> monitoring_report.md
          fi
          
          # å®‰å…¨æ£€æŸ¥ç»“æœ
          if [[ "${{ needs.security-check.result }}" == "success" ]]; then
            echo "- âœ… å®‰å…¨æ£€æŸ¥: é€šè¿‡" >> monitoring_report.md
          elif [[ "${{ needs.security-check.result }}" == "failure" ]]; then
            echo "- âŒ å®‰å…¨æ£€æŸ¥: å¤±è´¥" >> monitoring_report.md
          elif [[ "${{ needs.security-check.result }}" == "skipped" ]]; then
            echo "- â­ï¸ å®‰å…¨æ£€æŸ¥: è·³è¿‡" >> monitoring_report.md
          fi
          
          # æœåŠ¡å™¨èµ„æºæ£€æŸ¥ç»“æœ
          if [[ "${{ needs.server-resource-check.result }}" == "success" ]]; then
            echo "- âœ… æœåŠ¡å™¨èµ„æºæ£€æŸ¥: é€šè¿‡" >> monitoring_report.md
          elif [[ "${{ needs.server-resource-check.result }}" == "failure" ]]; then
            echo "- âŒ æœåŠ¡å™¨èµ„æºæ£€æŸ¥: å¤±è´¥" >> monitoring_report.md
          elif [[ "${{ needs.server-resource-check.result }}" == "skipped" ]]; then
            echo "- â­ï¸ æœåŠ¡å™¨èµ„æºæ£€æŸ¥: è·³è¿‡" >> monitoring_report.md
          fi
          
          echo "" >> monitoring_report.md
          echo "**æŸ¥çœ‹è¯¦æƒ…**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> monitoring_report.md
          
          # è¾“å‡ºæŠ¥å‘Š
          cat monitoring_report.md
      
      - name: å‘é€å‘Šè­¦é€šçŸ¥
        if: needs.basic-health-check.result == 'failure'
        run: |
          # æœåŠ¡å¼‚å¸¸æ—¶å‘é€å‘Šè­¦
          ALERT_MESSAGE="ğŸš¨ **æœåŠ¡å¼‚å¸¸å‘Šè­¦**
          
          **æ—¶é—´**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          **ç¯å¢ƒ**: ${{ inputs.environment || 'production' }}
          **çŠ¶æ€**: æœåŠ¡ä¸å¯ç”¨
          **æ£€æŸ¥ç»“æœ**: åŸºç¡€å¥åº·æ£€æŸ¥å¤±è´¥
          
          **ç´§æ€¥å¤„ç†**:
          1. æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€
          2. æŸ¥çœ‹åº”ç”¨æ—¥å¿—
          3. å¿…è¦æ—¶æ‰§è¡Œå›æ»š
          
          **æŸ¥çœ‹è¯¦æƒ…**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          echo "å‘Šè­¦é€šçŸ¥: $ALERT_MESSAGE"
          
          # è¿™é‡Œå¯ä»¥é›†æˆå®é™…çš„å‘Šè­¦æœåŠ¡
          # curl -X POST -H 'Content-Type: application/json' \
          #   -d "{\"text\": \"$ALERT_MESSAGE\"}" \
          #   "${{ secrets.ALERT_WEBHOOK_URL }}"
