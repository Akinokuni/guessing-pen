name: æ‰‹åŠ¨éƒ¨ç½²å’Œå›æ»š

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'æ“ä½œç±»å‹'
        required: true
        default: 'deploy'
        type: choice
        options:
          - deploy
          - rollback
          - restart
      environment:
        description: 'éƒ¨ç½²ç¯å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
      version:
        description: 'ç‰ˆæœ¬æ ‡ç­¾ (éƒ¨ç½²æ—¶å¿…å¡«ï¼Œå›æ»šæ—¶å¯é€‰)'
        required: false
        type: string
      force:
        description: 'å¼ºåˆ¶æ‰§è¡Œ (è·³è¿‡å¥åº·æ£€æŸ¥)'
        required: false
        default: false
        type: boolean

env:
  ACR_REGISTRY: registry.cn-hangzhou.aliyuncs.com
  ACR_NAMESPACE: guessing-pen
  FRONTEND_IMAGE: guessing-pen-frontend
  API_IMAGE: guessing-pen-api

jobs:
  manual-operation:
    name: ${{ inputs.action }} - ${{ inputs.environment }}
    runs-on: ubuntu-latest
    
    environment:
      name: ${{ inputs.environment }}
      url: ${{ vars.PRODUCTION_URL }}
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: éªŒè¯è¾“å…¥å‚æ•°
        run: |
          echo "ğŸ” éªŒè¯è¾“å…¥å‚æ•°..."
          
          ACTION="${{ inputs.action }}"
          ENVIRONMENT="${{ inputs.environment }}"
          VERSION="${{ inputs.version }}"
          FORCE="${{ inputs.force }}"
          
          echo "æ“ä½œç±»å‹: ${ACTION}"
          echo "éƒ¨ç½²ç¯å¢ƒ: ${ENVIRONMENT}"
          echo "ç‰ˆæœ¬æ ‡ç­¾: ${VERSION:-æœªæŒ‡å®š}"
          echo "å¼ºåˆ¶æ‰§è¡Œ: ${FORCE}"
          
          # éªŒè¯éƒ¨ç½²æ“ä½œå¿…é¡»æŒ‡å®šç‰ˆæœ¬
          if [[ "${ACTION}" == "deploy" && -z "${VERSION}" ]]; then
            echo "âŒ éƒ¨ç½²æ“ä½œå¿…é¡»æŒ‡å®šç‰ˆæœ¬æ ‡ç­¾"
            exit 1
          fi
          
          # è®¾ç½®ç¯å¢ƒå˜é‡
          echo "ACTION=${ACTION}" >> $GITHUB_ENV
          echo "ENVIRONMENT=${ENVIRONMENT}" >> $GITHUB_ENV
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          echo "FORCE=${FORCE}" >> $GITHUB_ENV
      
      - name: è·å–æœåŠ¡å™¨é…ç½®
        run: |
          # æ ¹æ®ç¯å¢ƒè®¾ç½®æœåŠ¡å™¨é…ç½®
          if [[ "${{ env.ENVIRONMENT }}" == "production" ]]; then
            echo "SERVER_HOST=${{ secrets.PROD_SERVER_HOST }}" >> $GITHUB_ENV
            echo "SERVER_USER=${{ secrets.PROD_SERVER_USER }}" >> $GITHUB_ENV
            echo "SERVER_SSH_KEY=${{ secrets.PROD_SERVER_SSH_KEY }}" >> $GITHUB_ENV
            echo "SERVER_PORT=${{ secrets.PROD_SERVER_PORT || 22 }}" >> $GITHUB_ENV
            echo "DEPLOY_PATH=/opt/guessing-pen" >> $GITHUB_ENV
          elif [[ "${{ env.ENVIRONMENT }}" == "staging" ]]; then
            echo "SERVER_HOST=${{ secrets.STAGING_SERVER_HOST }}" >> $GITHUB_ENV
            echo "SERVER_USER=${{ secrets.STAGING_SERVER_USER }}" >> $GITHUB_ENV
            echo "SERVER_SSH_KEY=${{ secrets.STAGING_SERVER_SSH_KEY }}" >> $GITHUB_ENV
            echo "SERVER_PORT=${{ secrets.STAGING_SERVER_PORT || 22 }}" >> $GITHUB_ENV
            echo "DEPLOY_PATH=/opt/guessing-pen-staging" >> $GITHUB_ENV
          fi
      
      - name: æ‰§è¡Œæ“ä½œ - ${{ inputs.action }}
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ env.SERVER_HOST }}
          username: ${{ env.SERVER_USER }}
          key: ${{ env.SERVER_SSH_KEY }}
          port: ${{ env.SERVER_PORT }}
          script: |
            set -e
            
            # è®¾ç½®å˜é‡
            ACTION="${{ env.ACTION }}"
            ENVIRONMENT="${{ env.ENVIRONMENT }}"
            VERSION="${{ env.VERSION }}"
            FORCE="${{ env.FORCE }}"
            DEPLOY_PATH="${{ env.DEPLOY_PATH }}"
            
            ACR_REGISTRY="${{ env.ACR_REGISTRY }}"
            ACR_NAMESPACE="${{ env.ACR_NAMESPACE }}"
            FRONTEND_IMAGE="${ACR_REGISTRY}/${ACR_NAMESPACE}/${{ env.FRONTEND_IMAGE }}"
            API_IMAGE="${ACR_REGISTRY}/${ACR_NAMESPACE}/${{ env.API_IMAGE }}"
            
            # åˆ›å»ºéƒ¨ç½²ç›®å½•
            mkdir -p "${DEPLOY_PATH}"
            cd "${DEPLOY_PATH}"
            
            # åˆ›å»ºæ—¥å¿—ç›®å½•
            mkdir -p logs backups
            
            # è®¾ç½®æ—¥å¿—æ–‡ä»¶
            LOG_FILE="logs/manual-${ACTION}-$(date +%Y%m%d-%H%M%S).log"
            
            # æ—¥å¿—å‡½æ•°
            log_info() {
              echo "[INFO] $(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$LOG_FILE"
            }
            
            log_success() {
              echo "[SUCCESS] $(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$LOG_FILE"
            }
            
            log_error() {
              echo "[ERROR] $(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$LOG_FILE"
              exit 1
            }
            
            # å¥åº·æ£€æŸ¥å‡½æ•°
            health_check() {
              local max_attempts=10
              local attempt=1
              
              log_info "æ‰§è¡Œå¥åº·æ£€æŸ¥..."
              
              while [[ $attempt -le $max_attempts ]]; do
                log_info "å¥åº·æ£€æŸ¥å°è¯• ${attempt}/${max_attempts}"
                
                # æ£€æŸ¥å‰ç«¯æœåŠ¡
                if curl -f -s http://localhost:80/health > /dev/null 2>&1; then
                  log_info "âœ… å‰ç«¯æœåŠ¡å¥åº·"
                else
                  log_info "âŒ å‰ç«¯æœåŠ¡å¼‚å¸¸"
                  if [[ "$FORCE" != "true" ]]; then
                    ((attempt++))
                    sleep 10
                    continue
                  fi
                fi
                
                # æ£€æŸ¥APIæœåŠ¡
                if curl -f -s http://localhost:3005/health > /dev/null 2>&1; then
                  log_info "âœ… APIæœåŠ¡å¥åº·"
                else
                  log_info "âŒ APIæœåŠ¡å¼‚å¸¸"
                  if [[ "$FORCE" != "true" ]]; then
                    ((attempt++))
                    sleep 10
                    continue
                  fi
                fi
                
                log_success "å¥åº·æ£€æŸ¥é€šè¿‡"
                return 0
              done
              
              if [[ "$FORCE" == "true" ]]; then
                log_info "âš ï¸ å¼ºåˆ¶æ¨¡å¼ï¼šè·³è¿‡å¥åº·æ£€æŸ¥å¤±è´¥"
                return 0
              else
                log_error "å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œå·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°"
              fi
            }
            
            # å¤‡ä»½å½“å‰çŠ¶æ€
            backup_current_state() {
              log_info "å¤‡ä»½å½“å‰çŠ¶æ€..."
              
              local backup_file="backups/backup-$(date +%Y%m%d-%H%M%S).json"
              
              # è·å–å½“å‰è¿è¡Œçš„å®¹å™¨ä¿¡æ¯
              local current_containers=$(docker-compose -f docker-compose.prod.yml ps --format json 2>/dev/null || echo "[]")
              
              # è·å–å½“å‰é•œåƒä¿¡æ¯
              local frontend_image=$(docker images "${FRONTEND_IMAGE}" --format "{{.Tag}}" | head -1 2>/dev/null || echo "unknown")
              local api_image=$(docker images "${API_IMAGE}" --format "{{.Tag}}" | head -1 2>/dev/null || echo "unknown")
              
              # åˆ›å»ºå¤‡ä»½ä¿¡æ¯
              cat > "$backup_file" << EOF
            {
              "timestamp": "$(date -u +'%Y-%m-%dT%H:%M:%SZ')",
              "environment": "${ENVIRONMENT}",
              "images": {
                "frontend": "${FRONTEND_IMAGE}:${frontend_image}",
                "api": "${API_IMAGE}:${api_image}"
              },
              "containers": ${current_containers}
            }
            EOF
              
              log_success "çŠ¶æ€å¤‡ä»½å®Œæˆ: $backup_file"
              echo "BACKUP_FILE=$backup_file" >> backup_info.env
            }
            
            # æ‰§è¡Œéƒ¨ç½²
            execute_deploy() {
              log_info "ğŸš€ å¼€å§‹éƒ¨ç½²ç‰ˆæœ¬: ${VERSION}"
              
              # ç™»å½•ACR
              log_info "ğŸ” ç™»å½•é˜¿é‡Œäº‘ACR..."
              echo "${{ secrets.ACR_PASSWORD }}" | docker login $ACR_REGISTRY -u "${{ secrets.ACR_USERNAME }}" --password-stdin
              
              # æ‹‰å–æŒ‡å®šç‰ˆæœ¬é•œåƒ
              log_info "ğŸ“¥ æ‹‰å–é•œåƒç‰ˆæœ¬: ${VERSION}"
              docker pull "${FRONTEND_IMAGE}:${VERSION}"
              docker pull "${API_IMAGE}:${VERSION}"
              
              # æ›´æ–°latestæ ‡ç­¾
              docker tag "${FRONTEND_IMAGE}:${VERSION}" "${FRONTEND_IMAGE}:latest"
              docker tag "${API_IMAGE}:${VERSION}" "${API_IMAGE}:latest"
              
              # åœæ­¢æ—§æœåŠ¡
              log_info "â¹ï¸ åœæ­¢æ—§æœåŠ¡..."
              docker-compose -f docker-compose.prod.yml down --remove-orphans || true
              
              # å¯åŠ¨æ–°æœåŠ¡
              log_info "ğŸš€ å¯åŠ¨æ–°æœåŠ¡..."
              docker-compose -f docker-compose.prod.yml up -d
              
              # ç­‰å¾…æœåŠ¡å¯åŠ¨
              sleep 30
              
              # å¥åº·æ£€æŸ¥
              health_check
              
              # è®°å½•éƒ¨ç½²ä¿¡æ¯
              cat > "deployment-info.json" << EOF
            {
              "version": "${VERSION}",
              "deployTime": "$(date -u +'%Y-%m-%dT%H:%M:%SZ')",
              "environment": "${ENVIRONMENT}",
              "deployedBy": "Manual Deploy - ${{ github.actor }}",
              "workflowRun": "${{ github.run_id }}",
              "frontendImage": "${FRONTEND_IMAGE}:${VERSION}",
              "apiImage": "${API_IMAGE}:${VERSION}"
            }
            EOF
              
              log_success "ğŸ‰ éƒ¨ç½²å®Œæˆï¼ç‰ˆæœ¬: ${VERSION}"
            }
            
            # æ‰§è¡Œå›æ»š
            execute_rollback() {
              log_info "ğŸ”„ å¼€å§‹å›æ»šæ“ä½œ..."
              
              # å¦‚æœæŒ‡å®šäº†ç‰ˆæœ¬ï¼Œå›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬
              if [[ -n "${VERSION}" ]]; then
                log_info "å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬: ${VERSION}"
                
                # ç™»å½•ACR
                echo "${{ secrets.ACR_PASSWORD }}" | docker login $ACR_REGISTRY -u "${{ secrets.ACR_USERNAME }}" --password-stdin
                
                # æ‹‰å–æŒ‡å®šç‰ˆæœ¬
                docker pull "${FRONTEND_IMAGE}:${VERSION}"
                docker pull "${API_IMAGE}:${VERSION}"
                
                # æ›´æ–°æ ‡ç­¾
                docker tag "${FRONTEND_IMAGE}:${VERSION}" "${FRONTEND_IMAGE}:latest"
                docker tag "${API_IMAGE}:${VERSION}" "${API_IMAGE}:latest"
              else
                # å›æ»šåˆ°ä¸Šä¸€ä¸ªå¤‡ä»½
                log_info "å›æ»šåˆ°ä¸Šä¸€ä¸ªå¤‡ä»½ç‰ˆæœ¬..."
                
                # æŸ¥æ‰¾æœ€æ–°çš„å¤‡ä»½æ–‡ä»¶
                local latest_backup=$(ls -t backups/backup-*.json 2>/dev/null | head -1)
                
                if [[ -z "$latest_backup" ]]; then
                  log_error "æœªæ‰¾åˆ°å¤‡ä»½æ–‡ä»¶ï¼Œæ— æ³•å›æ»š"
                fi
                
                log_info "ä½¿ç”¨å¤‡ä»½æ–‡ä»¶: $latest_backup"
                
                # ä»å¤‡ä»½æ–‡ä»¶ä¸­æå–é•œåƒä¿¡æ¯
                local frontend_backup_image=$(jq -r '.images.frontend' "$latest_backup")
                local api_backup_image=$(jq -r '.images.api' "$latest_backup")
                
                log_info "å›æ»šé•œåƒ: å‰ç«¯=${frontend_backup_image}, API=${api_backup_image}"
                
                # æ‹‰å–å¤‡ä»½ç‰ˆæœ¬é•œåƒ
                docker pull "$frontend_backup_image"
                docker pull "$api_backup_image"
                
                # æ›´æ–°æ ‡ç­¾
                docker tag "$frontend_backup_image" "${FRONTEND_IMAGE}:latest"
                docker tag "$api_backup_image" "${API_IMAGE}:latest"
              fi
              
              # é‡å¯æœåŠ¡
              log_info "ğŸ”„ é‡å¯æœåŠ¡..."
              docker-compose -f docker-compose.prod.yml down --remove-orphans
              docker-compose -f docker-compose.prod.yml up -d
              
              # ç­‰å¾…æœåŠ¡å¯åŠ¨
              sleep 30
              
              # å¥åº·æ£€æŸ¥
              health_check
              
              log_success "ğŸ‰ å›æ»šå®Œæˆï¼"
            }
            
            # æ‰§è¡Œé‡å¯
            execute_restart() {
              log_info "ğŸ”„ é‡å¯æœåŠ¡..."
              
              # é‡å¯æœåŠ¡
              docker-compose -f docker-compose.prod.yml restart
              
              # ç­‰å¾…æœåŠ¡å¯åŠ¨
              sleep 20
              
              # å¥åº·æ£€æŸ¥
              health_check
              
              log_success "ğŸ‰ æœåŠ¡é‡å¯å®Œæˆï¼"
            }
            
            # ä¸»æ‰§è¡Œé€»è¾‘
            log_info "å¼€å§‹æ‰§è¡Œæ“ä½œ: ${ACTION}"
            
            # å¤‡ä»½å½“å‰çŠ¶æ€ï¼ˆé™¤äº†é‡å¯æ“ä½œï¼‰
            if [[ "${ACTION}" != "restart" ]]; then
              backup_current_state
            fi
            
            # æ ¹æ®æ“ä½œç±»å‹æ‰§è¡Œç›¸åº”æ“ä½œ
            case "${ACTION}" in
              "deploy")
                execute_deploy
                ;;
              "rollback")
                execute_rollback
                ;;
              "restart")
                execute_restart
                ;;
              *)
                log_error "æœªçŸ¥æ“ä½œç±»å‹: ${ACTION}"
                ;;
            esac
            
            log_success "æ“ä½œå®Œæˆ: ${ACTION}"
      
      - name: æ“ä½œç»“æœé€šçŸ¥
        if: always()
        run: |
          # ç¡®å®šæ“ä½œçŠ¶æ€
          if [[ "${{ job.status }}" == "success" ]]; then
            STATUS="âœ… æˆåŠŸ"
            COLOR="good"
          else
            STATUS="âŒ å¤±è´¥"
            COLOR="danger"
          fi
          
          # æ„å»ºé€šçŸ¥æ¶ˆæ¯
          MESSAGE="ğŸ”§ **æ—®æ—¯ç”»å¸ˆæ‰‹åŠ¨æ“ä½œé€šçŸ¥**
          
          **æ“ä½œ**: ${{ inputs.action }}
          **ç¯å¢ƒ**: ${{ inputs.environment }}
          **çŠ¶æ€**: ${STATUS}
          **ç‰ˆæœ¬**: ${{ inputs.version || 'æœªæŒ‡å®š' }}
          **å¼ºåˆ¶æ‰§è¡Œ**: ${{ inputs.force }}
          **æ“ä½œè€…**: ${{ github.actor }}
          **å·¥ä½œæµ**: ${{ github.run_id }}
          **æ—¶é—´**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          
          **æŸ¥çœ‹è¯¦æƒ…**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          echo "æ“ä½œé€šçŸ¥: ${MESSAGE}"
          
          # è¿™é‡Œå¯ä»¥é›†æˆå®é™…çš„é€šçŸ¥æœåŠ¡
          # curl -X POST -H 'Content-Type: application/json' \
          #   -d "{\"text\": \"${MESSAGE}\"}" \
          #   "${{ secrets.WEBHOOK_URL }}"