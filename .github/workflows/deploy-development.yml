name: Deploy to Development

on:
  push:
    branches: [ develop ]
  pull_request:
    branches: [ develop ]

env:
  NODE_ENV: development
  ACR_REGISTRY: ${{ secrets.ACR_REGISTRY }}
  ACR_NAMESPACE: ${{ secrets.ACR_NAMESPACE_DEV }}
  IMAGE_TAG: dev-${{ github.sha }}

jobs:
  test:
    runs-on: ubuntu-latest
    name: è¿è¡Œæµ‹è¯•
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: å®‰è£…ä¾èµ–
      run: npm ci
      
    - name: è¿è¡Œä»£ç æ£€æŸ¥
      run: |
        # ä¸´æ—¶è·³è¿‡ESLintæ£€æŸ¥
        # npm run lint
        npm run type-check
        
    - name: è¿è¡Œæµ‹è¯•
      run: npm run test:unit || true
      
    - name: æ„å»ºåº”ç”¨
      run: npm run build:ci

  build-and-deploy:
    needs: test
    runs-on: ubuntu-latest
    name: æ„å»ºå’Œéƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒ
    if: github.ref == 'refs/heads/develop'
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: ç™»å½•é˜¿é‡Œäº‘ACR
      uses: docker/login-action@v3
      with:
        registry: ${{ secrets.ACR_REGISTRY }}
        username: ${{ secrets.ACR_USERNAME_DEV }}
        password: ${{ secrets.ACR_PASSWORD_DEV }}
        
    - name: æ„å»ºå‰ç«¯é•œåƒ
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: |
          ${{ secrets.ACR_REGISTRY }}/${{ secrets.ACR_NAMESPACE_DEV }}/guessing-pen-frontend:${{ env.IMAGE_TAG }}
          ${{ secrets.ACR_REGISTRY }}/${{ secrets.ACR_NAMESPACE_DEV }}/guessing-pen-frontend:dev-latest
        build-args: |
          NODE_ENV=development
          VITE_API_URL=${{ secrets.DEV_API_URL }}
          
    - name: æ„å»ºAPIé•œåƒ
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile.api
        push: true
        tags: |
          ${{ secrets.ACR_REGISTRY }}/${{ secrets.ACR_NAMESPACE_DEV }}/guessing-pen-api:${{ env.IMAGE_TAG }}
          ${{ secrets.ACR_REGISTRY }}/${{ secrets.ACR_NAMESPACE_DEV }}/guessing-pen-api:dev-latest
        build-args: |
          NODE_ENV=development
          
    - name: éƒ¨ç½²åˆ°å¼€å‘æœåŠ¡å™¨
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.DEV_SERVER_HOST }}
        username: ${{ secrets.DEV_SERVER_USER }}
        key: ${{ secrets.DEV_SERVER_SSH_KEY }}
        port: ${{ secrets.DEV_SERVER_PORT }}
        script: |
          # è®¾ç½®ç¯å¢ƒå˜é‡
          export ACR_REGISTRY="${{ secrets.ACR_REGISTRY }}"
          export ACR_NAMESPACE="${{ secrets.ACR_NAMESPACE_DEV }}"
          export IMAGE_TAG="${{ env.IMAGE_TAG }}"
          export DB_HOST="${{ secrets.DEV_DB_HOST }}"
          export DB_USER="${{ secrets.DEV_DB_USER }}"
          export DB_PASSWORD="${{ secrets.DEV_DB_PASSWORD }}"
          export DB_NAME="${{ secrets.DEV_DB_NAME }}"
          
          # ç™»å½•ACR
          echo "${{ secrets.ACR_PASSWORD_DEV }}" | docker login ${{ secrets.ACR_REGISTRY }} -u ${{ secrets.ACR_USERNAME_DEV }} --password-stdin
          
          # æ‹‰å–æœ€æ–°é•œåƒ
          docker pull ${{ secrets.ACR_REGISTRY }}/${{ secrets.ACR_NAMESPACE_DEV }}/guessing-pen-frontend:${{ env.IMAGE_TAG }}
          docker pull ${{ secrets.ACR_REGISTRY }}/${{ secrets.ACR_NAMESPACE_DEV }}/guessing-pen-api:${{ env.IMAGE_TAG }}
          
          # åœæ­¢æ—§å®¹å™¨
          docker-compose -f docker-compose.dev.yml down || true
          
          # å¯åŠ¨æ–°å®¹å™¨
          docker-compose -f docker-compose.dev.yml up -d
          
          # å¥åº·æ£€æŸ¥
          sleep 30
          curl -f http://localhost/health || exit 1
          
          # æ¸…ç†æ—§é•œåƒ
          docker image prune -f
          
    - name: å‘é€éƒ¨ç½²é€šçŸ¥
      if: always()
      run: |
        # ç¡®å®šéƒ¨ç½²çŠ¶æ€
        if [[ "${{ job.status }}" == "success" ]]; then
          STATUS="âœ… æˆåŠŸ"
        else
          STATUS="âŒ å¤±è´¥"
        fi
        
        # æ„å»ºé€šçŸ¥æ¶ˆæ¯
        MESSAGE="ğŸš€ **å¼€å‘ç¯å¢ƒéƒ¨ç½²é€šçŸ¥**
        
        **çŠ¶æ€**: ${STATUS}
        **é¡¹ç›®**: ${{ github.repository }}
        **åˆ†æ”¯**: ${{ github.ref_name }}
        **æäº¤**: ${{ github.sha }}
        **ä½œè€…**: ${{ github.actor }}
        **æ—¶é—´**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
        
        **æŸ¥çœ‹è¯¦æƒ…**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        
        echo "éƒ¨ç½²é€šçŸ¥: ${MESSAGE}"