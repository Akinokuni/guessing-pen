name: Deploy to Production

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  workflow_dispatch:
    inputs:
      version:
        description: 'éƒ¨ç½²ç‰ˆæœ¬æ ‡ç­¾'
        required: true
        default: 'latest'

env:
  NODE_ENV: production
  ACR_REGISTRY: ${{ secrets.ACR_REGISTRY }}
  ACR_NAMESPACE: ${{ secrets.ACR_NAMESPACE }}

jobs:
  security-scan:
    runs-on: ubuntu-latest
    name: å®‰å…¨æ‰«æ
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: å®‰è£…ä¾èµ–
      run: npm ci
        
    - name: ä¾èµ–å®‰å…¨æ£€æŸ¥
      run: |
        npm audit --audit-level high || true

  test:
    runs-on: ubuntu-latest
    name: å®Œæ•´æµ‹è¯•å¥—ä»¶
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: å®‰è£…ä¾èµ–
      run: npm ci
      
    - name: è¿è¡Œä»£ç æ£€æŸ¥
      run: |
        # ä¸´æ—¶è·³è¿‡ESLintæ£€æŸ¥
        # npm run lint
        npm run type-check
        
    - name: è¿è¡Œå•å…ƒæµ‹è¯•
      run: npm run test:unit || true
      
    - name: æ„å»ºåº”ç”¨
      run: npm run build
      


  build:
    needs: [security-scan, test]
    runs-on: ubuntu-latest
    name: æ„å»ºç”Ÿäº§é•œåƒ
    
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      image-digest: ${{ steps.build.outputs.digest }}
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: ç™»å½•é˜¿é‡Œäº‘ACR
      uses: docker/login-action@v3
      with:
        registry: ${{ secrets.ACR_REGISTRY }}
        username: ${{ secrets.ACR_USERNAME }}
        password: ${{ secrets.ACR_PASSWORD }}
        
    - name: æå–å…ƒæ•°æ®
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: |
          ${{ secrets.ACR_REGISTRY }}/${{ secrets.ACR_NAMESPACE }}/guessing-pen-frontend
          ${{ secrets.ACR_REGISTRY }}/${{ secrets.ACR_NAMESPACE }}/guessing-pen-api
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}
          
    - name: æ„å»ºå‰ç«¯é•œåƒ
      id: build-frontend
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: |
          ${{ secrets.ACR_REGISTRY }}/${{ secrets.ACR_NAMESPACE }}/guessing-pen-frontend:${{ github.sha }}
          ${{ secrets.ACR_REGISTRY }}/${{ secrets.ACR_NAMESPACE }}/guessing-pen-frontend:latest
        build-args: |
          NODE_ENV=production
          VITE_API_URL=${{ secrets.PROD_API_URL }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
    - name: æ„å»ºAPIé•œåƒ
      id: build-api
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile.api
        push: true
        tags: |
          ${{ secrets.ACR_REGISTRY }}/${{ secrets.ACR_NAMESPACE }}/guessing-pen-api:${{ github.sha }}
          ${{ secrets.ACR_REGISTRY }}/${{ secrets.ACR_NAMESPACE }}/guessing-pen-api:latest
        build-args: |
          NODE_ENV=production
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
    - name: é•œåƒå®‰å…¨æ‰«æ
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ secrets.ACR_REGISTRY }}/${{ secrets.ACR_NAMESPACE }}/guessing-pen-frontend:${{ github.sha }}
        format: 'sarif'
        output: 'trivy-results.sarif'
        
    - name: ä¸Šä¼ æ‰«æç»“æœ
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: 'trivy-results.sarif'

  deploy-staging:
    needs: build
    runs-on: ubuntu-latest
    name: éƒ¨ç½²åˆ°é¢„å‘å¸ƒç¯å¢ƒ
    environment: staging
    
    steps:
    - name: éƒ¨ç½²åˆ°é¢„å‘å¸ƒæœåŠ¡å™¨
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.STAGING_SERVER_HOST }}
        username: ${{ secrets.STAGING_SERVER_USER }}
        key: ${{ secrets.STAGING_SERVER_SSH_KEY }}
        port: ${{ secrets.STAGING_SERVER_PORT }}
        script: |
          # è®¾ç½®ç¯å¢ƒå˜é‡
          export ACR_REGISTRY="${{ secrets.ACR_REGISTRY }}"
          export ACR_NAMESPACE="${{ secrets.ACR_NAMESPACE }}"
          export IMAGE_TAG="${{ github.sha }}"
          export DB_HOST="${{ secrets.STAGING_DB_HOST }}"
          export DB_USER="${{ secrets.STAGING_DB_USER }}"
          export DB_PASSWORD="${{ secrets.STAGING_DB_PASSWORD }}"
          export DB_NAME="${{ secrets.STAGING_DB_NAME }}"
          
          # ç™»å½•ACR
          echo "${{ secrets.ACR_PASSWORD }}" | docker login ${{ secrets.ACR_REGISTRY }} -u ${{ secrets.ACR_USERNAME }} --password-stdin
          
          # æ‹‰å–æœ€æ–°é•œåƒ
          docker pull ${{ secrets.ACR_REGISTRY }}/${{ secrets.ACR_NAMESPACE }}/guessing-pen-frontend:${{ github.sha }}
          docker pull ${{ secrets.ACR_REGISTRY }}/${{ secrets.ACR_NAMESPACE }}/guessing-pen-api:${{ github.sha }}
          
          # åœæ­¢æ—§å®¹å™¨
          docker-compose -f docker-compose.staging.yml down || true
          
          # å¯åŠ¨æ–°å®¹å™¨
          docker-compose -f docker-compose.staging.yml up -d
          
          # å¥åº·æ£€æŸ¥
          sleep 30
          curl -f https://staging.your-domain.com/health || exit 1
          
    - name: è¿è¡Œå†’çƒŸæµ‹è¯•
      run: |
        # è¿è¡ŒåŸºæœ¬çš„å†’çƒŸæµ‹è¯•
        npm run test:smoke -- --baseUrl=https://staging.your-domain.com

  deploy-production:
    needs: [build, deploy-staging]
    runs-on: ubuntu-latest
    name: éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
    environment: production
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: äººå·¥å®¡æ‰¹æ£€æŸ¥
      uses: trstringer/manual-approval@v1
      with:
        secret: ${{ github.TOKEN }}
        approvers: admin1,admin2
        minimum-approvals: 2
        issue-title: "ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å®¡æ‰¹"
        issue-body: |
          è¯·å®¡æ‰¹ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²:
          - æäº¤: ${{ github.sha }}
          - åˆ†æ”¯: ${{ github.ref }}
          - ä½œè€…: ${{ github.actor }}
          
    - name: å¤‡ä»½å½“å‰ç”Ÿäº§ç¯å¢ƒ
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT }}
        script: |
          # åˆ›å»ºå¤‡ä»½
          mkdir -p /backup/$(date +%Y%m%d-%H%M%S)
          docker-compose -f docker-compose.prod.yml config > /backup/$(date +%Y%m%d-%H%M%S)/docker-compose.yml
          docker images --format "table {{.Repository}}:{{.Tag}}" | grep guessing-pen > /backup/$(date +%Y%m%d-%H%M%S)/images.txt
          
    - name: éƒ¨ç½²åˆ°ç”Ÿäº§æœåŠ¡å™¨
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT }}
        script: |
          # è®¾ç½®ç¯å¢ƒå˜é‡
          export ACR_REGISTRY="${{ secrets.ACR_REGISTRY }}"
          export ACR_NAMESPACE="${{ secrets.ACR_NAMESPACE }}"
          export IMAGE_TAG="${{ github.sha }}"
          export DB_HOST="${{ secrets.DB_HOST }}"
          export DB_USER="${{ secrets.DB_USER }}"
          export DB_PASSWORD="${{ secrets.DB_PASSWORD }}"
          export DB_NAME="${{ secrets.DB_NAME }}"
          
          # ç™»å½•ACR
          echo "${{ secrets.ACR_PASSWORD }}" | docker login ${{ secrets.ACR_REGISTRY }} -u ${{ secrets.ACR_USERNAME }} --password-stdin
          
          # æ‹‰å–æœ€æ–°é•œåƒ
          docker pull ${{ secrets.ACR_REGISTRY }}/${{ secrets.ACR_NAMESPACE }}/guessing-pen-frontend:${{ github.sha }}
          docker pull ${{ secrets.ACR_REGISTRY }}/${{ secrets.ACR_NAMESPACE }}/guessing-pen-api:${{ github.sha }}
          
          # æ»šåŠ¨æ›´æ–°
          docker-compose -f docker-compose.prod.yml up -d --no-deps frontend
          sleep 15
          docker-compose -f docker-compose.prod.yml up -d --no-deps api
          
          # å¥åº·æ£€æŸ¥
          sleep 30
          curl -f https://your-domain.com/health || exit 1
          
          # æ¸…ç†æ—§é•œåƒ
          docker image prune -f
          
    - name: éªŒè¯éƒ¨ç½²
      run: |
        # è¿è¡Œç”Ÿäº§ç¯å¢ƒéªŒè¯æµ‹è¯•
        npm run test:production -- --baseUrl=https://your-domain.com
        
    - name: æ›´æ–°latestæ ‡ç­¾
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT }}
        script: |
          # æ ‡è®°æˆåŠŸéƒ¨ç½²çš„é•œåƒä¸ºlatest
          docker tag ${{ secrets.ACR_REGISTRY }}/${{ secrets.ACR_NAMESPACE }}/guessing-pen-frontend:${{ github.sha }} ${{ secrets.ACR_REGISTRY }}/${{ secrets.ACR_NAMESPACE }}/guessing-pen-frontend:latest
          docker tag ${{ secrets.ACR_REGISTRY }}/${{ secrets.ACR_NAMESPACE }}/guessing-pen-api:${{ github.sha }} ${{ secrets.ACR_REGISTRY }}/${{ secrets.ACR_NAMESPACE }}/guessing-pen-api:latest
          
          # æ¨é€latestæ ‡ç­¾
          docker push ${{ secrets.ACR_REGISTRY }}/${{ secrets.ACR_NAMESPACE }}/guessing-pen-frontend:latest
          docker push ${{ secrets.ACR_REGISTRY }}/${{ secrets.ACR_NAMESPACE }}/guessing-pen-api:latest

  notify:
    needs: [deploy-production]
    runs-on: ubuntu-latest
    name: å‘é€éƒ¨ç½²é€šçŸ¥
    if: always()
    
    steps:
    - name: å‘é€éƒ¨ç½²é€šçŸ¥
      run: |
        # ç¡®å®šéƒ¨ç½²çŠ¶æ€
        if [[ "${{ needs.deploy-production.result }}" == "success" ]]; then
          STATUS="âœ… æˆåŠŸ"
          COLOR="good"
        else
          STATUS="âŒ å¤±è´¥"
          COLOR="danger"
        fi
        
        # æ„å»ºé€šçŸ¥æ¶ˆæ¯
        MESSAGE="ğŸš€ **ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²é€šçŸ¥**
        
        **çŠ¶æ€**: ${STATUS}
        **é¡¹ç›®**: ${{ github.repository }}
        **æäº¤**: ${{ github.sha }}
        **ä½œè€…**: ${{ github.actor }}
        **æ—¶é—´**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
        
        **æŸ¥çœ‹è¯¦æƒ…**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        
        echo "éƒ¨ç½²é€šçŸ¥: ${MESSAGE}"
        
        # è¿™é‡Œå¯ä»¥é›†æˆå®é™…çš„é€šçŸ¥æœåŠ¡
        # curl -X POST -H 'Content-Type: application/json' \
        #   -d "{\"text\": \"${MESSAGE}\"}" \
        #   "${{ secrets.WEBHOOK_URL }}"
