name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
    tags: ['v*.*.*']
  pull_request:
    branches: [main, develop]

env:
  # é˜¿é‡Œäº‘ACRé…ç½®
  ACR_REGISTRY: registry.cn-hangzhou.aliyuncs.com
  ACR_NAMESPACE: guessing-pen
  
  # é•œåƒåç§°
  FRONTEND_IMAGE: guessing-pen-frontend
  API_IMAGE: guessing-pen-api
  
  # Node.jsç‰ˆæœ¬
  NODE_VERSION: '18'

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥å’Œæµ‹è¯•
  test:
    name: ä»£ç æ£€æŸ¥å’Œæµ‹è¯•
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: è®¾ç½®Node.jsç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: å®‰è£…ä¾èµ–
        run: |
          npm ci
      
      - name: ä»£ç æ ¼å¼æ£€æŸ¥
        run: |
          npm run lint
        continue-on-error: false
      
      - name: TypeScriptç±»å‹æ£€æŸ¥
        run: |
          npm run type-check
        continue-on-error: false
      
      - name: è¿è¡Œå•å…ƒæµ‹è¯•
        run: |
          npm run test:unit
        continue-on-error: false
      
      - name: æ„å»ºåº”ç”¨
        run: |
          npm run build
        env:
          NODE_ENV: production
      
      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            dist/
            package.json
            package-lock.json
          retention-days: 1

  # Dockeré•œåƒæ„å»º
  build:
    name: æ„å»ºDockeré•œåƒ
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push'
    
    outputs:
      frontend-image: ${{ steps.meta.outputs.frontend-image }}
      api-image: ${{ steps.meta.outputs.api-image }}
      version: ${{ steps.meta.outputs.version }}
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
      
      - name: è®¾ç½®Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: ç™»å½•é˜¿é‡Œäº‘ACR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.ACR_REGISTRY }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}
      
      - name: ç”Ÿæˆé•œåƒå…ƒæ•°æ®
        id: meta
        run: |
          # è·å–Gitä¿¡æ¯
          GIT_COMMIT=$(git rev-parse --short HEAD)
          GIT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
          GIT_TAG=$(git describe --tags --exact-match 2>/dev/null || echo "")
          BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
          
          # ç”Ÿæˆç‰ˆæœ¬æ ‡ç­¾
          if [[ -n "$GIT_TAG" ]]; then
            VERSION="$GIT_TAG"
          elif [[ "$GIT_BRANCH" == "main" ]]; then
            VERSION="main-$GIT_COMMIT"
          else
            VERSION="$GIT_BRANCH-$GIT_COMMIT"
          fi
          
          # è®¾ç½®é•œåƒåç§°
          FRONTEND_IMAGE_FULL="${{ env.ACR_REGISTRY }}/${{ env.ACR_NAMESPACE }}/${{ env.FRONTEND_IMAGE }}"
          API_IMAGE_FULL="${{ env.ACR_REGISTRY }}/${{ env.ACR_NAMESPACE }}/${{ env.API_IMAGE }}"
          
          # è¾“å‡ºå˜é‡
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "frontend-image=$FRONTEND_IMAGE_FULL" >> $GITHUB_OUTPUT
          echo "api-image=$API_IMAGE_FULL" >> $GITHUB_OUTPUT
          echo "git-commit=$GIT_COMMIT" >> $GITHUB_OUTPUT
          echo "git-branch=$GIT_BRANCH" >> $GITHUB_OUTPUT
          echo "git-tag=$GIT_TAG" >> $GITHUB_OUTPUT
          echo "build-date=$BUILD_DATE" >> $GITHUB_OUTPUT
          
          # ç”Ÿæˆæ ‡ç­¾åˆ—è¡¨
          TAGS="$VERSION"
          if [[ "$GIT_BRANCH" == "main" ]]; then
            TAGS="$TAGS,latest"
          fi
          if [[ -n "$GIT_TAG" ]]; then
            TAGS="$TAGS,latest"
          fi
          
          echo "tags=$TAGS" >> $GITHUB_OUTPUT
      
      - name: æ„å»ºå¹¶æ¨é€å‰ç«¯é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ steps.meta.outputs.frontend-image }}:${{ steps.meta.outputs.version }}
            ${{ steps.meta.outputs.frontend-image }}:latest
          build-args: |
            BUILD_DATE=${{ steps.meta.outputs.build-date }}
            VERSION=${{ steps.meta.outputs.version }}
            GIT_COMMIT=${{ steps.meta.outputs.git-commit }}
            GIT_BRANCH=${{ steps.meta.outputs.git-branch }}
            GIT_TAG=${{ steps.meta.outputs.git-tag }}
            NODE_ENV=production
          labels: |
            org.opencontainers.image.created=${{ steps.meta.outputs.build-date }}
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.version=${{ steps.meta.outputs.version }}
            org.opencontainers.image.revision=${{ steps.meta.outputs.git-commit }}
            org.opencontainers.image.title=æ—®æ—¯ç”»å¸ˆå‰ç«¯
            org.opencontainers.image.description=AIè‰ºæœ¯é‰´åˆ«æ¸¸æˆå‰ç«¯åº”ç”¨
            org.opencontainers.image.vendor=Guessing Pen Team
            maintainer=Guessing Pen Team
            git.commit=${{ steps.meta.outputs.git-commit }}
            git.branch=${{ steps.meta.outputs.git-branch }}
            git.tag=${{ steps.meta.outputs.git-tag }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: æ„å»ºå¹¶æ¨é€APIé•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.api
          push: true
          tags: |
            ${{ steps.meta.outputs.api-image }}:${{ steps.meta.outputs.version }}
            ${{ steps.meta.outputs.api-image }}:latest
          build-args: |
            BUILD_DATE=${{ steps.meta.outputs.build-date }}
            VERSION=${{ steps.meta.outputs.version }}
            GIT_COMMIT=${{ steps.meta.outputs.git-commit }}
            GIT_BRANCH=${{ steps.meta.outputs.git-branch }}
            GIT_TAG=${{ steps.meta.outputs.git-tag }}
            NODE_ENV=production
          labels: |
            org.opencontainers.image.created=${{ steps.meta.outputs.build-date }}
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.version=${{ steps.meta.outputs.version }}
            org.opencontainers.image.revision=${{ steps.meta.outputs.git-commit }}
            org.opencontainers.image.title=æ—®æ—¯ç”»å¸ˆAPI
            org.opencontainers.image.description=AIè‰ºæœ¯é‰´åˆ«æ¸¸æˆAPIæœåŠ¡
            org.opencontainers.image.vendor=Guessing Pen Team
            maintainer=Guessing Pen Team
            git.commit=${{ steps.meta.outputs.git-commit }}
            git.branch=${{ steps.meta.outputs.git-branch }}
            git.tag=${{ steps.meta.outputs.git-tag }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: é•œåƒå®‰å…¨æ‰«æ
        run: |
          echo "ğŸ” é•œåƒå®‰å…¨æ‰«æ..."
          # è¿™é‡Œå¯ä»¥é›†æˆå®‰å…¨æ‰«æå·¥å…·ï¼Œå¦‚ Trivy
          # docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
          #   aquasec/trivy image ${{ steps.meta.outputs.frontend-image }}:${{ steps.meta.outputs.version }}
          echo "âœ… å®‰å…¨æ‰«æå®Œæˆ"

  # éƒ¨ç½²åˆ°äº‘æœåŠ¡å™¨
  deploy:
    name: éƒ¨ç½²åˆ°äº‘æœåŠ¡å™¨
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    environment:
      name: production
      url: ${{ vars.PRODUCTION_URL }}
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: éƒ¨ç½²åˆ°äº‘æœåŠ¡å™¨
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            set -e
            
            # å¯¼å…¥éƒ¨ç½²è„šæœ¬
            cd /opt/guessing-pen
            source scripts/deployment/logger.sh
            source scripts/deployment/deployment-tracker.sh
            source scripts/deployment/health-monitor.sh
            source scripts/deployment/notification-system.sh
            
            # å¼€å§‹éƒ¨ç½²è·Ÿè¸ª
            DEPLOYMENT_ID=$(start_deployment_tracking "${{ needs.build.outputs.version }}" "production" "auto")
            log_deployment_start "${{ needs.build.outputs.version }}" "production"
            
            # å‘é€éƒ¨ç½²å¼€å§‹é€šçŸ¥
            notify_deployment_start "${{ needs.build.outputs.version }}" "production" "${{ github.ref_name }}" "${{ github.sha }}" "${{ github.actor }}"
            
            # è®°å½•ç¯å¢ƒä¿¡æ¯
            log_environment_info
            
            # è®¾ç½®å˜é‡
            ACR_REGISTRY="${{ env.ACR_REGISTRY }}"
            ACR_NAMESPACE="${{ env.ACR_NAMESPACE }}"
            VERSION="${{ needs.build.outputs.version }}"
            FRONTEND_IMAGE="${{ needs.build.outputs.frontend-image }}"
            API_IMAGE="${{ needs.build.outputs.api-image }}"
            
            DEPLOYMENT_START_TIME=$(date +%s)
            
            # æ­¥éª¤1: ç™»å½•ACR
            log_step_start 1 "ç™»å½•é˜¿é‡Œäº‘ACR"
            update_deployment_step "acr_login" "in_progress" "æ­£åœ¨ç™»å½•é˜¿é‡Œäº‘ACR"
            
            if echo "${{ secrets.ACR_PASSWORD }}" | docker login $ACR_REGISTRY -u "${{ secrets.ACR_USERNAME }}" --password-stdin; then
              log_step_end 1 "ACRç™»å½•æˆåŠŸ"
              update_deployment_step "acr_login" "success" "ACRç™»å½•æˆåŠŸ"
            else
              log_error "ACRç™»å½•å¤±è´¥"
              update_deployment_step "acr_login" "failed" "ACRç™»å½•å¤±è´¥"
              add_deployment_error "ACRç™»å½•å¤±è´¥" "acr_login"
              notify_deployment_failure "${{ needs.build.outputs.version }}" "production" "acr_login" "ACRç™»å½•å¤±è´¥" "$(get_log_file)"
              exit 1
            fi
            
            # æ­¥éª¤2: æ‹‰å–é•œåƒ
            log_step_start 2 "æ‹‰å–æœ€æ–°é•œåƒ"
            update_deployment_step "image_pull" "in_progress" "æ­£åœ¨æ‹‰å–é•œåƒ"
            
            PULL_START_TIME=$(date +%s)
            if docker pull "${FRONTEND_IMAGE}:${VERSION}" && docker pull "${API_IMAGE}:${VERSION}"; then
              PULL_DURATION=$(($(date +%s) - PULL_START_TIME))
              log_step_end 2 "é•œåƒæ‹‰å–æˆåŠŸ" "${PULL_DURATION}"
              update_deployment_step "image_pull" "success" "é•œåƒæ‹‰å–æˆåŠŸ" "${PULL_DURATION}"
              
              # æ›´æ–°é•œåƒæ ‡ç­¾
              docker tag "${FRONTEND_IMAGE}:${VERSION}" "${FRONTEND_IMAGE}:latest"
              docker tag "${API_IMAGE}:${VERSION}" "${API_IMAGE}:latest"
            else
              log_error "é•œåƒæ‹‰å–å¤±è´¥"
              update_deployment_step "image_pull" "failed" "é•œåƒæ‹‰å–å¤±è´¥"
              add_deployment_error "é•œåƒæ‹‰å–å¤±è´¥" "image_pull"
              notify_deployment_failure "${{ needs.build.outputs.version }}" "production" "image_pull" "é•œåƒæ‹‰å–å¤±è´¥" "$(get_log_file)"
              exit 1
            fi
            
            # æ­¥éª¤3: å¤‡ä»½å½“å‰éƒ¨ç½²
            log_step_start 3 "å¤‡ä»½å½“å‰éƒ¨ç½²ä¿¡æ¯"
            update_deployment_step "backup" "in_progress" "æ­£åœ¨å¤‡ä»½å½“å‰éƒ¨ç½²"
            
            mkdir -p /opt/guessing-pen/backups
            BACKUP_FILE="/opt/guessing-pen/backups/deployment-$(date +%Y%m%d-%H%M%S).json"
            
            # å¤‡ä»½å®¹å™¨çŠ¶æ€
            docker-compose -f docker-compose.prod.yml ps --format json > "${BACKUP_FILE}" 2>/dev/null || echo '[]' > "${BACKUP_FILE}"
            
            # å¤‡ä»½å½“å‰ç‰ˆæœ¬ä¿¡æ¯
            if [[ -f "/opt/guessing-pen/deployment-info.json" ]]; then
              cp "/opt/guessing-pen/deployment-info.json" "/opt/guessing-pen/backups/previous-deployment-$(date +%Y%m%d-%H%M%S).json"
            fi
            
            log_step_end 3 "å¤‡ä»½å®Œæˆ"
            update_deployment_step "backup" "success" "å¤‡ä»½å®Œæˆ"
            
            # æ­¥éª¤4: åœæ­¢æ—§æœåŠ¡
            log_step_start 4 "åœæ­¢æ—§æœåŠ¡"
            update_deployment_step "service_stop" "in_progress" "æ­£åœ¨åœæ­¢æ—§æœåŠ¡"
            
            STOP_START_TIME=$(date +%s)
            if docker-compose -f docker-compose.prod.yml down --remove-orphans; then
              STOP_DURATION=$(($(date +%s) - STOP_START_TIME))
              log_step_end 4 "æœåŠ¡åœæ­¢æˆåŠŸ" "${STOP_DURATION}"
              update_deployment_step "service_stop" "success" "æœåŠ¡åœæ­¢æˆåŠŸ" "${STOP_DURATION}"
            else
              log_warning "æœåŠ¡åœæ­¢æ—¶å‡ºç°è­¦å‘Šï¼Œç»§ç»­éƒ¨ç½²"
              update_deployment_step "service_stop" "warning" "æœåŠ¡åœæ­¢æ—¶å‡ºç°è­¦å‘Š"
              add_deployment_warning "æœåŠ¡åœæ­¢æ—¶å‡ºç°è­¦å‘Š" "service_stop"
            fi
            
            # æ­¥éª¤5: æ¸…ç†æ—§é•œåƒ
            log_step_start 5 "æ¸…ç†æ—§é•œåƒ"
            update_deployment_step "cleanup" "in_progress" "æ­£åœ¨æ¸…ç†æ—§é•œåƒ"
            
            # ä¿ç•™æœ€è¿‘3ä¸ªç‰ˆæœ¬çš„é•œåƒ
            docker images "${FRONTEND_IMAGE}" --format "table {{.Tag}}\t{{.ID}}" | grep -v latest | tail -n +4 | awk '{print $2}' | xargs -r docker rmi 2>/dev/null || true
            docker images "${API_IMAGE}" --format "table {{.Tag}}\t{{.ID}}" | grep -v latest | tail -n +4 | awk '{print $2}' | xargs -r docker rmi 2>/dev/null || true
            
            log_step_end 5 "é•œåƒæ¸…ç†å®Œæˆ"
            update_deployment_step "cleanup" "success" "é•œåƒæ¸…ç†å®Œæˆ"
            
            # æ­¥éª¤6: å¯åŠ¨æ–°æœåŠ¡
            log_step_start 6 "å¯åŠ¨æ–°æœåŠ¡"
            update_deployment_step "service_start" "in_progress" "æ­£åœ¨å¯åŠ¨æ–°æœåŠ¡"
            
            START_TIME=$(date +%s)
            if docker-compose -f docker-compose.prod.yml up -d; then
              START_DURATION=$(($(date +%s) - START_TIME))
              log_step_end 6 "æœåŠ¡å¯åŠ¨æˆåŠŸ" "${START_DURATION}"
              update_deployment_step "service_start" "success" "æœåŠ¡å¯åŠ¨æˆåŠŸ" "${START_DURATION}"
            else
              log_error "æœåŠ¡å¯åŠ¨å¤±è´¥"
              update_deployment_step "service_start" "failed" "æœåŠ¡å¯åŠ¨å¤±è´¥"
              add_deployment_error "æœåŠ¡å¯åŠ¨å¤±è´¥" "service_start"
              notify_deployment_failure "${{ needs.build.outputs.version }}" "production" "service_start" "æœåŠ¡å¯åŠ¨å¤±è´¥" "$(get_log_file)"
              exit 1
            fi
            
            # æ­¥éª¤7: ç­‰å¾…æœåŠ¡å°±ç»ª
            log_step_start 7 "ç­‰å¾…æœåŠ¡å°±ç»ª"
            update_deployment_step "service_ready" "in_progress" "æ­£åœ¨ç­‰å¾…æœåŠ¡å°±ç»ª"
            
            if wait_for_services 120 10; then
              log_step_end 7 "æœåŠ¡å°±ç»ªæ£€æŸ¥é€šè¿‡"
              update_deployment_step "service_ready" "success" "æœåŠ¡å°±ç»ªæ£€æŸ¥é€šè¿‡"
            else
              log_error "æœåŠ¡å°±ç»ªæ£€æŸ¥å¤±è´¥"
              update_deployment_step "service_ready" "failed" "æœåŠ¡å°±ç»ªæ£€æŸ¥å¤±è´¥"
              add_deployment_error "æœåŠ¡å°±ç»ªæ£€æŸ¥å¤±è´¥" "service_ready"
              notify_deployment_failure "${{ needs.build.outputs.version }}" "production" "service_ready" "æœåŠ¡å°±ç»ªæ£€æŸ¥å¤±è´¥" "$(get_log_file)"
              exit 1
            fi
            
            # æ­¥éª¤8: å¥åº·æ£€æŸ¥
            log_step_start 8 "æ‰§è¡Œå¥åº·æ£€æŸ¥"
            update_deployment_step "health_check" "in_progress" "æ­£åœ¨æ‰§è¡Œå¥åº·æ£€æŸ¥"
            
            HEALTH_START_TIME=$(date +%s)
            if perform_health_check; then
              HEALTH_DURATION=$(($(date +%s) - HEALTH_START_TIME))
              log_step_end 8 "å¥åº·æ£€æŸ¥é€šè¿‡" "${HEALTH_DURATION}"
              update_deployment_step "health_check" "success" "å¥åº·æ£€æŸ¥é€šè¿‡" "${HEALTH_DURATION}"
            else
              log_error "å¥åº·æ£€æŸ¥å¤±è´¥"
              update_deployment_step "health_check" "failed" "å¥åº·æ£€æŸ¥å¤±è´¥"
              add_deployment_error "å¥åº·æ£€æŸ¥å¤±è´¥" "health_check"
              notify_deployment_failure "${{ needs.build.outputs.version }}" "production" "health_check" "å¥åº·æ£€æŸ¥å¤±è´¥" "$(get_log_file)"
              exit 1
            fi
            
            # æ­¥éª¤9: è®°å½•éƒ¨ç½²ä¿¡æ¯
            log_step_start 9 "è®°å½•éƒ¨ç½²ä¿¡æ¯"
            update_deployment_step "record_info" "in_progress" "æ­£åœ¨è®°å½•éƒ¨ç½²ä¿¡æ¯"
            
            cat > "/opt/guessing-pen/deployment-info.json" << EOF
            {
              "deploymentId": "${DEPLOYMENT_ID}",
              "version": "${VERSION}",
              "deployTime": "$(date -u +'%Y-%m-%dT%H:%M:%SZ')",
              "gitCommit": "${{ github.sha }}",
              "gitBranch": "${{ github.ref_name }}",
              "gitAuthor": "${{ github.actor }}",
              "frontendImage": "${FRONTEND_IMAGE}:${VERSION}",
              "apiImage": "${API_IMAGE}:${VERSION}",
              "deployedBy": "GitHub Actions",
              "workflowRun": "${{ github.run_id }}",
              "workflowUrl": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
              "environment": "production",
              "status": "success"
            }
            EOF
            
            log_step_end 9 "éƒ¨ç½²ä¿¡æ¯è®°å½•å®Œæˆ"
            update_deployment_step "record_info" "success" "éƒ¨ç½²ä¿¡æ¯è®°å½•å®Œæˆ"
            
            # å®Œæˆéƒ¨ç½²è·Ÿè¸ª
            TOTAL_DURATION=$(($(date +%s) - DEPLOYMENT_START_TIME))
            finish_deployment_tracking "success" "${TOTAL_DURATION}"
            log_deployment_end "success" "${TOTAL_DURATION}"
            
            # å‘é€éƒ¨ç½²æˆåŠŸé€šçŸ¥
            notify_deployment_success "${{ needs.build.outputs.version }}" "production" "${TOTAL_DURATION}" "${{ vars.PRODUCTION_URL }}"
            
            # å¯åŠ¨ç›‘æ§ç³»ç»Ÿ
            log_info "å¯åŠ¨ç›‘æ§ç³»ç»Ÿ..."
            if [[ -f "scripts/deployment/monitoring-system.sh" ]]; then
              bash scripts/deployment/monitoring-system.sh restart
            fi
            
            # æ”¶é›†éƒ¨ç½²åçš„æ—¥å¿—
            log_info "æ”¶é›†éƒ¨ç½²åçš„å®¹å™¨æ—¥å¿—..."
            if [[ -f "scripts/deployment/log-collector.sh" ]]; then
              bash scripts/deployment/log-collector.sh collect 10m
            fi
            
            log_success "ğŸ‰ éƒ¨ç½²å®Œæˆï¼ç‰ˆæœ¬: ${VERSION} (è€—æ—¶: ${TOTAL_DURATION}ç§’)"
      
      - name: éƒ¨ç½²åéªŒè¯
        run: |
          echo "ğŸ” æ‰§è¡Œéƒ¨ç½²åéªŒè¯..."
          
          # ç­‰å¾…æœåŠ¡å®Œå…¨å¯åŠ¨
          sleep 10
          
          # éªŒè¯å‰ç«¯æœåŠ¡
          if curl -f -s "${{ vars.PRODUCTION_URL }}" > /dev/null; then
            echo "âœ… å‰ç«¯æœåŠ¡éªŒè¯é€šè¿‡"
          else
            echo "âŒ å‰ç«¯æœåŠ¡éªŒè¯å¤±è´¥"
            exit 1
          fi
          
          # éªŒè¯APIæœåŠ¡
          if curl -f -s "${{ vars.PRODUCTION_URL }}/api/health" > /dev/null; then
            echo "âœ… APIæœåŠ¡éªŒè¯é€šè¿‡"
          else
            echo "âŒ APIæœåŠ¡éªŒè¯å¤±è´¥"
            exit 1
          fi
          
          echo "ğŸ‰ éƒ¨ç½²éªŒè¯å®Œæˆï¼"

  # éƒ¨ç½²é€šçŸ¥
  notify:
    name: éƒ¨ç½²é€šçŸ¥
    runs-on: ubuntu-latest
    needs: [build, deploy]
    if: always() && github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: å‘é€éƒ¨ç½²é€šçŸ¥
        run: |
          # ç¡®å®šéƒ¨ç½²çŠ¶æ€
          if [[ "${{ needs.deploy.result }}" == "success" ]]; then
            STATUS="âœ… æˆåŠŸ"
            COLOR="good"
          else
            STATUS="âŒ å¤±è´¥"
            COLOR="danger"
          fi
          
          # æ„å»ºé€šçŸ¥æ¶ˆæ¯
          MESSAGE="ğŸš€ **æ—®æ—¯ç”»å¸ˆéƒ¨ç½²é€šçŸ¥**
          
          **çŠ¶æ€**: ${STATUS}
          **ç‰ˆæœ¬**: ${{ needs.build.outputs.version }}
          **åˆ†æ”¯**: ${{ github.ref_name }}
          **æäº¤**: ${{ github.sha }}
          **è§¦å‘è€…**: ${{ github.actor }}
          **å·¥ä½œæµ**: ${{ github.run_id }}
          **æ—¶é—´**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          
          **é•œåƒä¿¡æ¯**:
          - å‰ç«¯: ${{ needs.build.outputs.frontend-image }}:${{ needs.build.outputs.version }}
          - API: ${{ needs.build.outputs.api-image }}:${{ needs.build.outputs.version }}
          
          **æŸ¥çœ‹è¯¦æƒ…**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          echo "éƒ¨ç½²é€šçŸ¥: ${MESSAGE}"
          
          # è¿™é‡Œå¯ä»¥é›†æˆå®é™…çš„é€šçŸ¥æœåŠ¡ï¼Œå¦‚é’‰é’‰ã€ä¼ä¸šå¾®ä¿¡ã€Slackç­‰
          # curl -X POST -H 'Content-Type: application/json' \
          #   -d "{\"text\": \"${MESSAGE}\"}" \
          #   "${{ secrets.WEBHOOK_URL }}"

# å·¥ä½œæµçº§åˆ«çš„ç¯å¢ƒå˜é‡å’Œé…ç½®
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true